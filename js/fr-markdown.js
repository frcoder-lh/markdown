function setName(a){return"fr-"+a}function getName(a){return a=a.toString(),"fr-"===a.substring(0,3)?a.substring(3):null}function newDoc(a,b){if(isExistsInDocNames(a))return!1;saveDoc(a,b);var c=getDocNames();return c.push(a),localStorage.docnames=c,!0}function saveDoc(a,b){localStorage.setItem(setName(a),b)}function delDoc(a){localStorage.removeItem(setName(a)),localStorage.removeItem(setName(a)+"-url");var b=getDocNames();b.splice($.inArray(a,b),1),localStorage.docnames=b}function nowDoc(a){return null!=a&&(localStorage.doc_now=a),localStorage.doc_now}function isExistsInDocNames(a){return-1!=(","+localStorage.docnames+",").indexOf(","+a+",")?!0:!1}function getDocNames(){return localStorage.docnames?localStorage.docnames.toString().split(","):[]}function setDocUrl(a,b){localStorage.setItem(setName(a)+"-url",b)}function getDocUrl(a){return localStorage.getItem(setName(a)+"-url")}function addSelect(a){$("#doc-select").append("<option value="+a+">"+a+"</option>"),$("#doc-select").val(a)}function setSelect(a){nowDoc(a),$("#doc-select").val(a),editor.setValue(localStorage.getItem(setName(a))),$("#publishUrl").text(getDocUrl(a)).attr("href",getDocUrl(a))}function delSelect(a){$("#doc-select option[value='"+a+"']").remove()}function openFile(a){if(void 0!=a){var b=new FileReader;b.onload=function(){var a=getRealContent(this.result.toString());return null==a&&(a=this.result),-1!=a.indexOf("�")&&confirm("文件编码错误，将进行自动修正。")?(switchEncode(),alert("修正完毕，请重新上传！"),void 0):((""==$.trim(editor.getValue())||1==confirm("确认导入文档？当前内容将被覆盖!"))&&editor.setValue(a),void 0)},b.readAsText(a,encodeType)}}function saveFile(){var a=prompt("保存为：",nowDoc());null!=a&&(a=a.replace(/\ +/g,""),DownloadText(a+".html",getOutContents()),editor.focus())}function getRealContent(a){var b=a.toString().match(/<!---([\s\S]*)---->/im);return null!=b?b[0].slice(5,-5):null}function setRealContent(a,b){return"<!---"+a+"---->\n"+b}function importPublishedFile(){var a=prompt("文档地址：");null!=a&&(a=decodeURI(a.replace(/\ +/g,"")),$.ajax({type:"GET",url:a.endsWith(".html")?a:a+".html",success:function(b){var c=getRealContent(b);null==c&&(c=b),(""==$.trim(editor.getValue())||1==confirm("确认导入文档？当前内容将被覆盖!"))&&(editor.setValue(c),editor.focus(),$("#publishUrl").text(a).attr("href",a),setDocUrl(nowDoc(),a))},error:function(){alert("地址不存在！")}}))}function publishFile(){var a,b,c,d;if(""==$.trim(getUserName())&&setUserName(),""!=$.trim(getUserName())){if(a=prompt("发布为：",nowDoc()),null==a)return;a=a.replace(/\ +/g,""),b=getUserName()+"/"+a,c=getOutContents(),d=prompt("创建文档密码："),""==$.trim(d)?githubSaveFile(githubUrl+b+".html",c,function(){alert("发布成功！");var c=publishBaseUrl+b;$("#publishUrl").text(c).attr("href",c),setDocUrl(a,c)},function(){alert("发布失败！")}):appendPassWord(d,function(c){githubSaveFile(githubUrl+b+".html",c,function(){alert("发布成功！");var c=publishBaseUrl+b;$("#publishUrl").text(c).attr("href",c),setDocUrl(a,c)},function(){alert("发布失败！")})},function(){alert("文档加密失败！")})}editor.focus()}function updatePublishedFile(){var b,c,a=getDocUrl(nowDoc());return a?(a=githubUrl+a.slice(publishBaseUrl.length),a.endsWith(".html")||(a+=".html"),b=getOutContents(),c=prompt("创建文档密码："),""==$.trim(c)?githubUpdateFile(a,b,function(){alert("更新成功！")},function(){alert("更新失败，请稍后重试！")}):appendPassWord(c,function(b){githubUpdateFile(a,b,function(){alert("更新成功！")},function(){alert("更新失败，请稍后重试！")})},function(){alert("文档加密失败！")}),void 0):(alert("请先发布文档！"),void 0)}function switchEncode(){encodeType="utf-8"===encodeType?"gbk":"utf-8"}function getOutContents(){return setRealContent(editor.getValue(),$("#out").contents().find("html").html())}function appendPassWord(a,b,c){function g(){d++,d===e.length&&(void 0==f["out.html"]||void 0==f["css/fr-password.css"]||void 0==f["js/fr-password.js"]?c():h())}function h(){var c=f["out.html"];c=c.replace("<!---css/fr-password.css---->",'<style type="text/css">'+f["css/fr-password.css"]+"</style>"),c=c.replace("<!---js/fr-password.js---->",'<script language="javascript">'+f["js/fr-password.js"]+"</script>"),c=c.replace("@password@",a),c=c.replace("@content@",$("#out").contents().find("body").html()),c=setRealContent(editor.getValue(),c),b(c)}var d=0,e=["out.html","js/fr-password.js","css/fr-password.css"],f={};e.forEach(function(a){$.ajax({type:"GET",url:a,success:function(b){f[a]=b,g()},error:function(){g()}})})}function setUserName(){var a=prompt("请输入用户名：",localStorage.username);""!=$.trim(a)&&(localStorage.username=a.replace(/\ +/g,""))}function getUserName(){return localStorage.username}function getGithubToken(){return githubToken1+githubToken2+githubToken3}function githubGetFileInfo(a,b,c){$.ajax({type:"GET",url:a,data:{ref:gitBranch},success:b,error:c})}function githubSaveFile(a,b,c,d){$.ajax({type:"PUT",url:a,headers:{Authorization:"token "+getGithubToken()},data:JSON.stringify({branch:gitBranch,message:"save",content:Base64Encode(b)}),dataType:"json",ContentType:"application/json",success:c,error:d})}function githubUpdateFile(a,b,c,d){githubGetFileInfo(a,function(e){$.ajax({type:"PUT",url:a,headers:{Authorization:"token "+getGithubToken()},data:JSON.stringify({branch:gitBranch,message:"update",sha:e.sha,content:Base64Encode(b)}),dataType:"json",ContentType:"application/json",success:c,error:d})},function(){alert("更新失败：文件不存在，请重新发布！")})}function out(a){$("#out").contents().find("body").html(marked(a))}function initIE(){String.prototype.startsWith=String.prototype.startsWith||function(a){var b=new RegExp("^"+a);return b.test(this)},String.prototype.endsWith=String.prototype.endsWith||function(a){var b=new RegExp(a+"$");return b.test(this)}}function initParam(){encodeType="utf-8"}function initStore(){localStorage.docnames?initSelete():$.ajax({url:welcomeDocUrl,success:function(a){newDoc(welcomeDocName,a),nowDoc(welcomeDocName)},error:function(){newDoc(welcomeDocName,welcomeDocContent),nowDoc(welcomeDocName)},complete:function(){initSelete()}})}function initSelete(){$.each(getDocNames(),function(a,b){null!=b&&$("#doc-select").append("<option value="+b+">"+b+"</option>")}),setSelect(nowDoc())}function initBind(){$("#openFile").on("change",function(){openFile(document.getElementById("openFile").files[0])}),new ClipboardJS("#copyPublishUrl",{text:function(){return $("#publishUrl").text()}}),$("#publishUrl").bind("contextmenu",function(){return!1}).mousedown(function(a){3==a.which&&($("#copyPublishUrl").click(),alert("地址已复制到剪切板！"))})}function initDrag(){$(document).on({dragleave:function(a){a.preventDefault()},drop:function(a){a.preventDefault()},dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()}}),$(document).keydown(function(a){return 1==a.ctrlKey&&83==a.keyCode?(saveFile(),!1):void 0})}function GB2312UTF8(){this.Dig2Dec=function(s){var i,retV=0;if(4==s.length){for(i=0;4>i;i++)retV+=eval(s.charAt(i))*Math.pow(2,3-i);return retV}return-1},this.Hex2Utf8=function(s){var sss,i,retS="",tempS="",ss="";if(16==s.length){for(tempS="1110"+s.substring(0,4),tempS+="10"+s.substring(4,10),tempS+="10"+s.substring(10,16),sss="0123456789ABCDEF",i=0;3>i;i++)retS+="%",ss=tempS.substring(8*i,8*(eval(i)+1)),retS+=sss.charAt(this.Dig2Dec(ss.substring(0,4))),retS+=sss.charAt(this.Dig2Dec(ss.substring(4,8)));return retS}return""},this.Dec2Dig=function(a){var d,b="",c=0;for(d=0;4>d;d++)c=Math.pow(2,3-d),a>=c?(b+="1",a-=c):b+="0";return b},this.Str2Hex=function(s){var n,i,c="",ss="0123456789ABCDEF",digS="";for(i=0;i<s.length;i++)c=s.charAt(i),n=ss.indexOf(c),digS+=this.Dec2Dig(eval(n));return digS},this.Gb2312ToUtf8=function(a){var e,b=escape(a),c=b.split("%"),d="";for(""!=c[0]&&(d=c[0]),e=1;e<c.length;e++)"u"==c[e].substring(0,1)?(d+=this.Hex2Utf8(this.Str2Hex(c[e].substring(1,5))),c[e].length&&(d+=c[e].substring(5))):(d+=unescape("%"+c[e]),c[e].length&&(d+=c[e].substring(5)));return d},this.Utf8ToGb2312=function(a){var g,b="",c="",d="",e="",f=-1;if(f=a.indexOf("%"),-1==f)return a;for(;-1!=f;)3>f?(b+=a.substr(0,f-1),a=a.substr(f+1,a.length-f),c=a.substr(0,2),a=a.substr(2,a.length-2),parseInt("0x"+c)&!1?b+=String.fromCharCode(parseInt("0x"+c)):parseInt("0x"+c)&!1?(d=a.substr(1,2),a=a.substr(3,a.length-3),g=(31&parseInt("0x"+c))<<6,g|=63&parseInt("0x"+d),b+=String.fromCharCode(g)):(d=a.substr(1,2),a=a.substr(3,a.length-3),e=a.substr(1,2),a=a.substr(3,a.length-3),g=(15&parseInt("0x"+c))<<12,g|=(63&parseInt("0x"+d))<<6,g|=63&parseInt("0x"+e),b+=String.fromCharCode(g))):(b+=a.substring(0,f),a=a.substring(f)),f=a.indexOf("%");return b+a}}function DownloadText(a,b){var c,d,e,f,g;void 0!=document.createElement("a").download?(c=document.createElement("a"),d=new Blob([b]),c.download=a,c.href=URL.createObjectURL(d),c.click()):(e=BrowseFolder(),f=new ActiveXObject("Scripting.FileSystemObject"),g=f.CreateTextFile(e+a,!0),g.write(b),g.Close())}function BrowseFolder(){var a,b,c;try{if(a="请选择保存文件夹",b=new ActiveXObject("Shell.Application"),c=b.BrowseForFolder(0,a,0),null!=c)return c=c.items(),c=c.item(),c=c.Path,"\\"!=c.charAt(c.length-1)&&(c+="\\"),c}catch(d){alert(d.message)}}function Base64Encode(a){var c,d,e,f,g,h,i,b="",j=0;for(a=_utf8_encode(a);j<a.length;)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+keyStr.charAt(f)+keyStr.charAt(g)+keyStr.charAt(h)+keyStr.charAt(i);return b}function Base64Decode(a){var c,d,e,f,g,h,i,b="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)f=keyStr.indexOf(a.charAt(j++)),g=keyStr.indexOf(a.charAt(j++)),h=keyStr.indexOf(a.charAt(j++)),i=keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,b+=String.fromCharCode(c),64!=h&&(b+=String.fromCharCode(d)),64!=i&&(b+=String.fromCharCode(e));return b=_utf8_decode(b)}function _utf8_encode(a){var b,c,d;for(a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++)d=a.charCodeAt(c),128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(192|d>>6),b+=String.fromCharCode(128|63&d)):(b+=String.fromCharCode(224|d>>12),b+=String.fromCharCode(128|63&d>>6),b+=String.fromCharCode(128|63&d));return b}function _utf8_decode(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):d>191&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((31&d)<<6|63&c2),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((15&d)<<12|(63&c2)<<6|63&c3),c+=3);return b}var welcomeDocName="欢迎使用",welcomeDocContent="hello world!",welcomeDocUrl="welcome.md",publishBaseUrl="http://book.littletools.ml/",keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",githubUrl="https://api.github.com/repos/little-tools/md/contents/",githubToken1="f8765952ea0e",githubToken3="95a588e6d",githubToken2="232c9bec20cf5b855db",gitBranch="gh-pages";editor=ace.edit("in"),editor.focus(),editor.setFontSize(12),editor.setReadOnly(!1),editor.setOption("wrap","free"),editor.setShowPrintMargin(!1),editor.$blockScrolling=1/0,ace.require("ace/ext/language_tools"),$("#doc-select").on("change",function(){setSelect(nowDoc($("#doc-select").val()))}),$("#new").click(function(){for(var b,a=0;isExistsInDocNames("新建文档"+(0==a?"":"("+a+")"));)a++;b=prompt("请输入新文档名：","新建文档"+(0==a?"":"("+a+")")),null!=b&&(b=b.replace(/\ +/g,""),newDoc(b,"")?(addSelect(b),setSelect(b)):alert('文档名："'+b+'"已被使用，请重新命名。'),editor.focus())}),$("#delete").click(function(){nowDoc()===welcomeDocName?alert("本文件为系统文件，不能删除！"):confirm("确认删除！")&&(delDoc(nowDoc()),delSelect(nowDoc()),setSelect(getDocNames()[getDocNames().length-1])),editor.focus()}),$("#open").click(function(){$("#openFile").click(),editor.focus()}),document.body.addEventListener("drop",function(a){a.preventDefault(),openFile(a.dataTransfer.files[0])},!1),$("#save").click(function(){saveFile()}),$("#import").click(function(){importPublishedFile()}),$("#publish").click(function(){publishFile()}),$("#update").click(function(){updatePublishedFile()}),$("#settings").click(function(){setUserName(),editor.focus()}),editor.getSession().on("change",function(){out(editor.getValue()),saveDoc(nowDoc(),editor.getValue())}),window.onload=function(){initIE(),initParam(),initStore(),initBind(),initDrag()};